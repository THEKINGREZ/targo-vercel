
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- بخش اصلی اطلاعات مانگا -->
    <div class="lg:col-span-2 space-y-6">
        <!-- دکمه‌های عملکرد -->
        <div class="flex flex-wrap gap-3 justify-center sm:justify-start">
            <% if (chapters && chapters.length > 0) { %>
                <% const firstChapter = chapters[chapters.length - 1]; %>
                <a href="/chapter/<%= firstChapter.id %>" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    شروع مطالعه
                </a>
                
                <% if (user && continueChapterId) { %>
                    <a href="/chapter/<%= continueChapterId %>" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        ادامه مطالعه
                    </a>
                <% } %>
            <% } %>
            
            <% if (user) { %>
                <button id="bookmark-toggle" data-manga-id="<%= manga.id %>" data-bookmarked="<%= isBookmarked %>" 
                        class="<%= isBookmarked ? 'bg-red-500 hover:bg-red-600' : 'bg-zinc-600 hover:bg-zinc-700' %> text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                    </svg>
                    <span><%= isBookmarked ? 'حذف از علاقه‌مندی‌ها' : 'افزودن به علاقه‌مندی‌ها' %></span>
                </button>
            <% } %>
        </div>

        <!-- توضیحات -->
        <% if (manga.description && manga.description.trim() !== '') { %>
            <div class="bg-zinc-900/50 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-sky-300 mb-4">درباره مانگا</h3>
                <div class="text-zinc-300 leading-relaxed">
                    <div id="description-preview" class="line-clamp-3">
                        <%- manga.description.replace(/\n/g, '<br>') %>
                    </div>
                    <div id="description-full" class="hidden">
                        <%- manga.description.replace(/\n/g, '<br>') %>
                    </div>
                    <% if (manga.description.length > 300) { %>
                        <button id="description-toggle" class="text-sky-400 hover:text-sky-300 text-sm font-semibold mt-2">
                            نمایش بیشتر
                        </button>
                    <% } %>
                </div>
            </div>
        <% } %>

        <!-- ژانرها -->
        <% if (genres && genres.length > 0) { %>
            <div class="bg-zinc-900/50 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-sky-300 mb-4">ژانرها</h3>
                <div class="flex flex-wrap gap-2">
                    <% genres.forEach(genre => { %>
                        <span class="bg-sky-500/20 text-sky-300 px-3 py-1 rounded-full text-sm font-medium border border-sky-500/30">
                            <%= genre.name %>
                        </span>
                    <% }); %>
                </div>
            </div>
        <% } %>
    </div>

    <!-- بخش اطلاعات جانبی -->
    <div class="space-y-6">
        <!-- آمار -->
        <div class="bg-zinc-900/50 rounded-lg p-6">
            <h3 class="text-xl font-semibold text-sky-300 mb-4">آمار</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-zinc-400">تعداد بازدید:</span>
                    <span class="font-semibold text-zinc-100"><%= (manga.view_count || 0).toLocaleString('fa-IR') %></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-zinc-400">تعداد قسمت‌ها:</span>
                    <span class="font-semibold text-zinc-100"><%= total_chapters_count || 0 %></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-zinc-400">وضعیت:</span>
                    <span class="font-semibold <%= manga.status === 'ongoing' ? 'text-green-400' : manga.status === 'completed' ? 'text-blue-400' : 'text-yellow-400' %>">
                        <%= manga.status === 'ongoing' ? 'در حال انتشار' : manga.status === 'completed' ? 'تمام شده' : 'متوقف شده' %>
                    </span>
                </div>
            </div>
        </div>

        <!-- اطلاعات تکمیلی -->
        <div class="bg-zinc-900/50 rounded-lg p-6">
            <h3 class="text-xl font-semibold text-sky-300 mb-4">جزئیات</h3>
            <div class="space-y-3">
                <% if (manga.author) { %>
                    <div class="flex justify-between items-center">
                        <span class="text-zinc-400">نویسنده:</span>
                        <span class="font-semibold text-zinc-100"><%= manga.author %></span>
                    </div>
                <% } %>
                <% if (manga.artist) { %>
                    <div class="flex justify-between items-center">
                        <span class="text-zinc-400">هنرمند:</span>
                        <span class="font-semibold text-zinc-100"><%= manga.artist %></span>
                    </div>
                <% } %>
                <% if (manga.release_year) { %>
                    <div class="flex justify-between items-center">
                        <span class="text-zinc-400">سال انتشار:</span>
                        <span class="font-semibold text-zinc-100"><%= manga.release_year %></span>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle description
    const descToggle = document.getElementById('description-toggle');
    if (descToggle) {
        const preview = document.getElementById('description-preview');
        const full = document.getElementById('description-full');
        
        descToggle.addEventListener('click', function() {
            if (full.classList.contains('hidden')) {
                preview.classList.add('hidden');
                full.classList.remove('hidden');
                descToggle.textContent = 'نمایش کمتر';
            } else {
                preview.classList.remove('hidden');
                full.classList.add('hidden');
                descToggle.textContent = 'نمایش بیشتر';
            }
        });
    }

    // Bookmark functionality
    const bookmarkBtn = document.getElementById('bookmark-toggle');
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', async function() {
            const mangaId = this.dataset.mangaId;
            const isBookmarked = this.dataset.bookmarked === 'true';
            const action = isBookmarked ? 'unbookmark' : 'bookmark';
            
            try {
                const response = await fetch('/bookmark/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mangaId, action })
                });
                
                const result = await response.json();
                if (result.success) {
                    const newState = result.status === 'bookmarked';
                    this.dataset.bookmarked = newState;
                    this.className = newState 
                        ? 'bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center gap-2'
                        : 'bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center gap-2';
                    this.querySelector('span').textContent = newState 
                        ? 'حذف از علاقه‌مندی‌ها' 
                        : 'افزودن به علاقه‌مندی‌ها';
                }
            } catch (error) {
                console.error('Bookmark error:', error);
            }
        });
    }
});
</script>
