<%- include('partials/header') %>

<style>
    /* General Styles */
    body {
        background-color: #111827; /* A slightly lighter dark blue-gray */
        color: #e5e7eb;
    }

    /* Custom scrollbar for carousels */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4b5563; }

    /* Skeleton Animation */
    @keyframes shimmer {
        0% { background-position: -1200px 0; }
        100% { background-position: 1200px 0; }
    }
    .animate-shimmer {
        animation: shimmer 1.8s infinite linear;
        background: linear-gradient(to right, #1f2937 4%, #374151 25%, #1f2937 36%);
        background-size: 1200px 100%;
    }

    /* Tab styles */
    .tab-button.active {
        color: #38bdf8; /* sky-400 */
        border-color: #38bdf8;
    }
    
    /* Manga Card Enhancements */
    .manga-card .cover-image {
        transition: transform 0.3s ease-in-out;
    }
    .manga-card:hover .cover-image {
        transform: scale(1.05);
    }
    .manga-card .info-overlay {
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .manga-card:hover .info-overlay {
        opacity: 1;
    }
</style>

<div class="container mx-auto px-4 space-y-16 py-8">

    <!-- Featured Section -->
    <section id="featured-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[60vh] min-h-[500px] max-h-[600px]">
        <!-- Main Featured Item -->
        <div id="featured-main" class="lg:col-span-2 h-full bg-zinc-800 rounded-2xl animate-shimmer">
            <!-- Skeleton for main featured item -->
        </div>
        <!-- Side Featured Items -->
        <div class="hidden lg:flex flex-col gap-6 h-full">
            <div id="featured-side-1" class="h-1/2 bg-zinc-800 rounded-2xl animate-shimmer"></div>
            <div id="featured-side-2" class="h-1/2 bg-zinc-800 rounded-2xl animate-shimmer"></div>
        </div>
    </section>

    <!-- Stats Section -->
    <section id="stats-section">
        <%- include('partials/_stats') %>
    </section>

    <!-- Explore Section with Tabs -->
    <section id="explore-section">
        <div class="flex items-center justify-between mb-6 border-b-2 border-zinc-800 pb-3">
            <h2 class="text-3xl font-bold text-sky-400">کاوش کنید</h2>
            <div id="tabs-container" class="flex space-x-4 space-x-reverse text-lg font-semibold">
                <button class="tab-button border-b-2 border-transparent transition-colors pb-2 active" data-tab="latest-updates">🚀 بروزرسانی‌ها</button>
                <button class="tab-button border-b-2 border-transparent transition-colors pb-2" data-tab="popular">🔥 محبوب‌ها</button>
                <button class="tab-button border-b-2 border-transparent transition-colors pb-2" data-tab="recent">✨ جدیدترین‌ها</button>
            </div>
        </div>
        
        <!-- Tab Content -->
        <div id="tab-content-container" class="relative">
            <!-- Latest Updates Carousel -->
            <div id="latest-updates-carousel" class="flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4">
                <% for (let i = 0; i < 8; i++) { %>
                    <div class="flex-shrink-0 w-44"><div class="bg-zinc-800 rounded-lg animate-shimmer aspect-[2/3]"></div></div>
                <% } %>
            </div>
            <!-- Popular Carousel (hidden by default) -->
            <div id="popular-mangas-carousel" class="hidden flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4">
                 <% for (let i = 0; i < 8; i++) { %>
                    <div class="flex-shrink-0 w-44"><div class="bg-zinc-800 rounded-lg animate-shimmer aspect-[2/3]"></div></div>
                <% } %>
            </div>
            <!-- Recent Mangas Carousel (hidden by default) -->
            <div id="recent-mangas-carousel" class="hidden flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4">
                <% for (let i = 0; i < 8; i++) { %>
                    <div class="flex-shrink-0 w-44"><div class="bg-zinc-800 rounded-lg animate-shimmer aspect-[2/3]"></div></div>
                <% } %>
            </div>
        </div>
    </section>

    <!-- Genre Spotlight Section -->
    <section id="genre-spotlight-section" class="bg-zinc-900/50 p-8 rounded-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
            <div class="md:col-span-1 text-center md:text-right">
                <h3 class="text-zinc-400 text-lg">ژانر منتخب</h3>
                <h2 class="text-5xl font-extrabold text-amber-400 my-3">اکشن</h2>
                <p class="text-zinc-300 leading-relaxed mb-6">
                    آثاری پر از هیجان، مبارزات نفس‌گیر و ماجراجویی‌های بی‌پایان که شما را در جای خود میخکوب می‌کنند.
                </p>
                <a href="/mangas?genres=ACTION_GENRE_ID" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition-colors">
                    مشاهده همه
                </a>
            </div>
            <div id="genre-spotlight-carousel" class="md:col-span-2 flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4 -mr-8 pr-8">
                 <% for (let i = 0; i < 4; i++) { %>
                    <div class="flex-shrink-0 w-44"><div class="bg-zinc-800 rounded-lg animate-shimmer aspect-[2/3]"></div></div>
                <% } %>
            </div>
        </div>
    </section>

    <!-- Top Channels Section -->
    <section id="top-channels-section">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-green-400">📢 کانال‌های برتر</h2>
            <a href="/channels" class="text-sm text-sky-400 hover:text-sky-300 transition-colors">مشاهده همه &raquo;</a>
        </div>
        <div id="top-channels-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <% for (let i = 0; i < 4; i++) { %>
                <div class="bg-zinc-800 rounded-lg animate-shimmer h-24"></div>
            <% } %>
        </div>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    function createMangaCard(manga) {
        return `
            <a href="/manga/${manga.id}" class="manga-card block bg-zinc-800 rounded-lg shadow-lg overflow-hidden group relative aspect-[2/3] w-44 flex-shrink-0">
                <img src="${manga.cover_image_url || 'https://placehold.co/300x450/1f2937/374151?text=کاور'}"
                     alt="[کاور ${manga.title}]"
                     class="cover-image w-full h-full object-cover" loading="lazy">
                <div class="info-overlay absolute inset-0 p-3 flex flex-col justify-end">
                    <h3 class="font-bold text-white text-lg leading-tight">${manga.title}</h3>
                    <p class="text-xs text-zinc-300 mt-1">${manga.source_channel_name || 'نامشخص'}</p>
                </div>
            </a>
        `;
    }

    function createChannelCard(channel) {
        return `
            <a href="/channel/${channel.id}" class="bg-zinc-800 p-4 rounded-lg flex items-center gap-4 hover:bg-zinc-700/50 transition-colors group">
                <img src="${channel.profile_image_url || 'https://placehold.co/64x64/374151/9ca3af?text=' + encodeURIComponent(channel.name.substring(0,1))}"
                     alt="[پروفایل ${channel.name}]"
                     class="w-16 h-16 rounded-full object-cover border-2 border-zinc-700 group-hover:border-green-400 transition-colors">
                <div class="overflow-hidden">
                    <h3 class="font-semibold text-zinc-100 truncate group-hover:text-green-300 transition-colors" title="${channel.name}">${channel.name}</h3>
                    <p class="text-sm text-zinc-400">${channel.manga_count || 0} اثر</p>
                </div>
            </a>
        `;
    }
    
    function createFeaturedCard(manga, isMain = false) {
        const genresHTML = (manga.genres || []).slice(0, 3).map(g => `<span class="text-xs font-semibold px-3 py-1 bg-white/10 backdrop-blur-sm rounded-full">${g.name}</span>`).join('');
        if (isMain) {
            return `
                <div class="relative w-full h-full rounded-2xl overflow-hidden group">
                    <img src="${manga.banner_image_url || manga.cover_image_url}" class="absolute inset-0 w-full h-full object-cover object-center transition-transform duration-500 group-hover:scale-105" alt="[بنر ${manga.title}]">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/50 to-transparent"></div>
                    <div class="relative z-10 flex flex-col justify-end h-full p-8 text-white">
                        <h2 class="text-4xl font-extrabold">${manga.title}</h2>
                        <p class="mt-2 max-w-xl text-zinc-300 line-clamp-2">${manga.description || ''}</p>
                        <div class="flex flex-wrap gap-2 my-4">${genresHTML}</div>
                        <a href="/manga/${manga.id}" class="mt-4 bg-sky-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-600 transition-colors w-fit">
                            مشاهده و خواندن
                        </a>
                    </div>
                </div>
            `;
        } else {
             return `
                <div class="relative w-full h-full rounded-2xl overflow-hidden group">
                    <img src="${manga.cover_image_url}" class="absolute inset-0 w-full h-full object-cover object-center transition-transform duration-300 group-hover:scale-105" alt="[کاور ${manga.title}]">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                    <div class="relative z-10 flex flex-col justify-end h-full p-4 text-white">
                        <h3 class="font-bold text-xl">${manga.title}</h3>
                        <a href="/manga/${manga.id}" class="text-sm text-sky-300 hover:underline mt-1">شروع خواندن &raquo;</a>
                    </div>
                </div>
            `;
        }
    }

    function populateCarousel(carouselElement, items, cardCreatorFunction) {
        if (!carouselElement || !items || items.length === 0) {
            if(carouselElement) carouselElement.innerHTML = '<p class="text-zinc-400 px-4">موردی برای نمایش یافت نشد.</p>';
            return;
        }
        carouselElement.innerHTML = items.map(cardCreatorFunction).join('');
    }
    
    function populateGrid(gridElement, items, cardCreatorFunction) {
        if (!gridElement || !items || items.length === 0) {
            if(gridElement) gridElement.innerHTML = '<p class="text-zinc-400 px-4 col-span-full text-center">موردی برای نمایش یافت نشد.</p>';
            return;
        }
        gridElement.innerHTML = items.map(cardCreatorFunction).join('');
    }

    // Tab switching logic
    const tabsContainer = document.getElementById('tabs-container');
    const tabContentContainer = document.getElementById('tab-content-container');
    tabsContainer.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            tabsContainer.querySelector('.active').classList.remove('active');
            e.target.classList.add('active');
            
            Array.from(tabContentContainer.children).forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`${e.target.dataset.tab}-carousel`).classList.remove('hidden');
        }
    });

    function animateCount(elementId, finalValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        let startValue = 0;
        const duration = 1500;
        const stepTime = Math.max(1, Math.floor(duration / finalValue));
        
        const timer = setInterval(() => {
            startValue += Math.ceil(finalValue / (duration / stepTime));
            if (startValue >= finalValue) {
                startValue = finalValue;
                clearInterval(timer);
            }
            element.textContent = startValue.toLocaleString('fa-IR');
        }, stepTime);
    }

    // Fetch all homepage data
    fetch('/api/home-data')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Populate Featured Section
                if (data.popularMangas && data.popularMangas.length > 0) {
                    document.getElementById('featured-main').innerHTML = createFeaturedCard(data.popularMangas[0], true);
                    if (data.popularMangas.length > 1) {
                        document.getElementById('featured-side-1').innerHTML = createFeaturedCard(data.popularMangas[1], false);
                    }
                    if (data.popularMangas.length > 2) {
                        document.getElementById('featured-side-2').innerHTML = createFeaturedCard(data.popularMangas[2], false);
                    }
                }

                // Populate Carousels
                populateCarousel(document.getElementById('latest-updates-carousel'), data.latestUpdates, createMangaCard);
                populateCarousel(document.getElementById('popular-mangas-carousel'), data.popularMangas, createMangaCard);
                populateCarousel(document.getElementById('recent-mangas-carousel'), data.recentMangas, createMangaCard);

                // Populate Genre Spotlight (using some popular mangas as example)
                populateCarousel(document.getElementById('genre-spotlight-carousel'), data.popularMangas.slice(3, 8), createMangaCard);

                // Populate Top Channels
                populateGrid(document.getElementById('top-channels-grid'), data.suggestedChannels.slice(0, 4), createChannelCard);

                // Animate Stats
                if (data.siteStats) {
                    animateCount('stats-manga-count', data.siteStats.mangaCount);
                    animateCount('stats-chapter-count', data.siteStats.chapterCount);
                    animateCount('stats-channel-count', data.siteStats.channelCount);
                }

            } else { throw new Error(data.message || 'Failed to load data.'); }
        })
        .catch(error => {
            console.error('Error fetching homepage data:', error);
            const errorMsg = '<p class="text-red-400 text-center w-full p-10">خطا در بارگذاری اطلاعات.</p>';
            document.getElementById('featured-section').innerHTML = errorMsg;
            document.getElementById('explore-section').innerHTML = errorMsg;
        });
});
</script>

<%- include('partials/footer') %>
