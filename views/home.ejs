
<%- include('partials/header') %>

<div id="homepage-content">
    <!-- Hero Section with Loading -->
    <section class="relative bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900 py-16 overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-sky-500/10 to-purple-500/10"></div>
        <div class="container mx-auto px-4 relative z-10">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6">
                    <span class="bg-gradient-to-r from-sky-400 to-purple-400 bg-clip-text text-transparent">
                        Targo
                    </span>
                </h1>
                <p class="text-xl md:text-2xl text-zinc-300 mb-8">بهترین مجموعه مانگا با ترجمه فارسی</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <a href="/mangas" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition-colors inline-flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        شروع مطالعه
                    </a>
                    <a href="/channels" class="border-2 border-sky-500 text-sky-400 hover:bg-sky-500 hover:text-white font-bold py-3 px-8 rounded-lg transition-colors inline-flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                        </svg>
                        کانال‌ها
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Loading State -->
    <div id="homepage-loading" class="container mx-auto px-4 py-12 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-400 mx-auto mb-4"></div>
        <p class="text-zinc-400">در حال بارگذاری محتوا...</p>
    </div>

    <!-- Main Content (Hidden initially) -->
    <div id="homepage-main" class="hidden">
        <!-- Popular Slider -->
        <section id="popular-section" class="py-12 bg-zinc-900/50">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-sky-400 mb-8 text-center">🔥 محبوب‌ترین مانگاها</h2>
                <div id="popular-slider" class="relative">
                    <div class="overflow-hidden rounded-xl">
                        <div id="popular-slides" class="flex transition-transform duration-500"></div>
                    </div>
                    <button id="popular-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/>
                        </svg>
                    </button>
                    <button id="popular-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                        </svg>
                    </button>
                    <div id="popular-dots" class="flex justify-center mt-6 space-x-2"></div>
                </div>
            </div>
        </section>

        <!-- Recent Mangas -->
        <section class="py-12">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-sky-400">📚 جدیدترین مانگاها</h2>
                    <a href="/mangas?sort_by=created_at_desc" class="text-sky-400 hover:text-sky-300 font-semibold">مشاهده همه</a>
                </div>
                <div id="recent-mangas" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>
        </section>

        <!-- Latest Updates -->
        <section class="py-12 bg-zinc-900/30">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-sky-400">🆕 آخرین به‌روزرسانی‌ها</h2>
                    <a href="/mangas?sort_by=updated_at_desc" class="text-sky-400 hover:text-sky-300 font-semibold">مشاهده همه</a>
                </div>
                <div id="latest-updates" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>
        </section>

        <!-- Suggested Channels -->
        <section class="py-12">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-sky-400">📢 کانال‌های پیشنهادی</h2>
                    <a href="/channels" class="text-sky-400 hover:text-sky-300 font-semibold">مشاهده همه</a>
                </div>
                <div id="suggested-channels" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="py-12 bg-gradient-to-r from-sky-500/10 to-purple-500/10">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-3xl font-bold text-sky-400 mb-8">📊 آمار سایت</h2>
                <div id="site-stats" class="grid grid-cols-1 sm:grid-cols-3 gap-8"></div>
            </div>
        </section>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const loadingEl = document.getElementById('homepage-loading');
    const mainContentEl = document.getElementById('homepage-main');

    try {
        const response = await fetch('/api/home-data');
        const data = await response.json();

        if (!data.success) throw new Error('Failed to load data');

        // Render Popular Slider
        renderPopularSlider(data.popularMangas);
        
        // Render Recent Mangas
        renderMangaGrid(data.recentMangas, 'recent-mangas');
        
        // Render Latest Updates
        renderMangaGrid(data.latestUpdates, 'latest-updates');
        
        // Render Suggested Channels
        renderChannels(data.suggestedChannels);
        
        // Render Stats
        renderStats(data.siteStats);

        // Show content and hide loading
        loadingEl.classList.add('hidden');
        mainContentEl.classList.remove('hidden');

    } catch (error) {
        console.error('Error loading homepage data:', error);
        loadingEl.innerHTML = `
            <div class="text-center py-12">
                <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h2 class="text-xl font-bold text-red-400 mb-2">خطا در بارگذاری</h2>
                <p class="text-zinc-400">متأسفانه در بارگذاری اطلاعات خطایی رخ داد.</p>
                <button onclick="location.reload()" class="mt-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg">
                    تلاش مجدد
                </button>
            </div>
        `;
    }
});

function renderPopularSlider(mangas) {
    const slidesContainer = document.getElementById('popular-slides');
    const dotsContainer = document.getElementById('popular-dots');
    let currentSlide = 0;

    if (!mangas || mangas.length === 0) {
        document.getElementById('popular-section').style.display = 'none';
        return;
    }

    mangas.forEach((manga, index) => {
        const slide = document.createElement('div');
        slide.className = 'min-w-full relative bg-zinc-800 rounded-xl overflow-hidden';
        slide.innerHTML = `
            <div class="flex flex-col md:flex-row">
                <div class="md:w-1/3 aspect-[2/3] md:aspect-auto">
                    <img src="${manga.cover_image_url}" alt="${manga.title}" class="w-full h-full object-cover">
                </div>
                <div class="md:w-2/3 p-8 flex flex-col justify-center">
                    <h3 class="text-3xl font-bold text-white mb-4">${manga.title}</h3>
                    <p class="text-zinc-300 mb-6 line-clamp-3">${manga.description || 'توضیحی موجود نیست.'}</p>
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${manga.genres ? manga.genres.map(g => `<span class="bg-sky-500/20 text-sky-300 px-3 py-1 rounded-full text-sm">${g.name}</span>`).join('') : ''}
                    </div>
                    <div class="flex items-center gap-4 mb-6">
                        <span class="flex items-center gap-2 text-zinc-400">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                            ${(manga.view_count || 0).toLocaleString('fa-IR')} بازدید
                        </span>
                        ${manga.latest_chapter_number ? `<span class="text-zinc-400">قسمت ${manga.latest_chapter_number}</span>` : ''}
                    </div>
                    <div class="flex gap-4">
                        <a href="/manga/${manga.id}" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            مشاهده جزئیات
                        </a>
                        ${manga.first_chapter_id ? `<a href="/chapter/${manga.first_chapter_id}" class="border-2 border-sky-500 text-sky-400 hover:bg-sky-500 hover:text-white font-bold py-3 px-6 rounded-lg transition-colors">شروع مطالعه</a>` : ''}
                    </div>
                </div>
            </div>
        `;
        slidesContainer.appendChild(slide);

        const dot = document.createElement('button');
        dot.className = `w-3 h-3 rounded-full transition-colors ${index === 0 ? 'bg-sky-400' : 'bg-zinc-600'}`;
        dot.addEventListener('click', () => goToSlide(index));
        dotsContainer.appendChild(dot);
    });

    function goToSlide(index) {
        currentSlide = index;
        slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
        dotsContainer.querySelectorAll('button').forEach((dot, i) => {
            dot.className = `w-3 h-3 rounded-full transition-colors ${i === currentSlide ? 'bg-sky-400' : 'bg-zinc-600'}`;
        });
    }

    document.getElementById('popular-prev').addEventListener('click', () => {
        currentSlide = currentSlide > 0 ? currentSlide - 1 : mangas.length - 1;
        goToSlide(currentSlide);
    });

    document.getElementById('popular-next').addEventListener('click', () => {
        currentSlide = currentSlide < mangas.length - 1 ? currentSlide + 1 : 0;
        goToSlide(currentSlide);
    });

    // Auto-slide
    setInterval(() => {
        currentSlide = currentSlide < mangas.length - 1 ? currentSlide + 1 : 0;
        goToSlide(currentSlide);
    }, 5000);
}

function renderMangaGrid(mangas, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (!mangas || mangas.length === 0) {
        container.innerHTML = '<p class="text-zinc-400 col-span-full text-center">محتوایی موجود نیست.</p>';
        return;
    }

    mangas.forEach(manga => {
        const card = document.createElement('div');
        card.className = 'bg-zinc-800 rounded-lg overflow-hidden shadow-lg hover:shadow-xl hover:shadow-sky-500/20 transition-all duration-300 group';
        card.innerHTML = `
            <a href="/manga/${manga.id}" class="block">
                <div class="aspect-[2/3] overflow-hidden relative">
                    <img src="${manga.cover_image_url}" alt="${manga.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy">
                    ${manga.latest_chapter_number ? `<div class="absolute bottom-2 right-2 bg-black/70 text-white px-2 py-1 rounded text-xs">قسمت ${manga.latest_chapter_number}</div>` : ''}
                </div>
                <div class="p-3">
                    <h3 class="text-sm font-semibold text-zinc-100 group-hover:text-sky-400 transition-colors line-clamp-2" title="${manga.title}">${manga.title}</h3>
                    ${manga.source_channel_name ? `<p class="text-xs text-zinc-400 mt-1 truncate">منبع: ${manga.source_channel_name}</p>` : ''}
                </div>
            </a>
        `;
        container.appendChild(card);
    });
}

function renderChannels(channels) {
    const container = document.getElementById('suggested-channels');
    container.innerHTML = '';

    if (!channels || channels.length === 0) {
        container.innerHTML = '<p class="text-zinc-400 col-span-full text-center">کانالی موجود نیست.</p>';
        return;
    }

    channels.forEach(channel => {
        const card = document.createElement('div');
        card.className = 'bg-zinc-800 rounded-lg p-6 hover:bg-zinc-700 transition-colors group';
        card.innerHTML = `
            <div class="flex items-center mb-4">
                <img src="${channel.profile_image_url || `https://placehold.co/64x64/3f3f46/a1a1aa?text=${encodeURIComponent(channel.name.substring(0,1))}`}" 
                     alt="${channel.name}" class="w-12 h-12 rounded-full object-cover border-2 border-zinc-600 group-hover:border-sky-500 transition-colors">
                <div class="mr-3 min-w-0 flex-grow">
                    <h3 class="font-semibold text-zinc-100 group-hover:text-sky-400 transition-colors truncate">${channel.name}</h3>
                    ${channel.telegram_handle ? `<p class="text-sm text-sky-400 truncate">@${channel.telegram_handle}</p>` : ''}
                </div>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-zinc-400">${channel.manga_count || 0} مانگا</span>
                <a href="/channel/${channel.id}" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-md text-sm font-semibold transition-colors">
                    مشاهده
                </a>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderStats(stats) {
    const container = document.getElementById('site-stats');
    const statsData = [
        { label: 'تعداد مانگا', value: stats.mangaCount, icon: '📚' },
        { label: 'تعداد قسمت', value: stats.chapterCount, icon: '📖' },
        { label: 'تعداد کانال', value: stats.channelCount, icon: '📢' }
    ];

    statsData.forEach(stat => {
        const statCard = document.createElement('div');
        statCard.className = 'bg-zinc-800/50 rounded-lg p-6';
        statCard.innerHTML = `
            <div class="text-4xl mb-2">${stat.icon}</div>
            <div class="text-3xl font-bold text-sky-400 mb-1">${(stat.value || 0).toLocaleString('fa-IR')}</div>
            <div class="text-zinc-400">${stat.label}</div>
        `;
        container.appendChild(statCard);
    });
}
</script>

<%- include('partials/footer') %>
