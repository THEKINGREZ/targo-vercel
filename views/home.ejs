<%- include('partials/header') %>

<style>
    /* A more premium, deep-blue background for a cinematic feel */
    body {
        background-color: #0c1425;
        color: #e5e7eb;
    }

    /* Custom scrollbar for carousels */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #374151; }

    /* A smoother, more subtle skeleton animation */
    @keyframes shimmer {
        0% { background-position: -1200px 0; }
        100% { background-position: 1200px 0; }
    }
    .animate-shimmer {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(to right, #1f2937 8%, #374151 18%, #1f2937 33%);
        background-size: 1200px 100%;
    }

    /* --- FIXED: Advanced Tab Switcher --- */
    .tabs-container {
        position: relative;
        display: flex;
        background-color: #1f2937;
        padding: 6px;
        border-radius: 9999px; /* pill shape */
        width: fit-content;
    }
    .tab-glider {
        position: absolute;
        top: 6px;
        height: calc(100% - 12px);
        background-color: #38bdf8; /* sky-400 */
        border-radius: 9999px;
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);
    }
    .tab-button {
        position: relative;
        z-index: 1;
        padding: 10px 24px;
        font-weight: 600;
        color: #9ca3af; /* gray-400 */
        border-radius: 9999px;
        transition: color 0.3s ease;
        white-space: nowrap;
        background: none;
        border: none;
        cursor: pointer;
    }
    .tab-button.active {
        color: #ffffff;
    }
    
    /* --- FIXED: Carousel transition effect --- */
    .carousel-content {
        transition: opacity 0.3s ease-in-out, visibility 0.3s;
        opacity: 1;
        visibility: visible;
    }
    .carousel-content.hidden {
        opacity: 0;
        visibility: hidden;
        /* Using display none to prevent layout issues */
        display: none;
    }
    
    /* Enhanced Manga Card with fluid, detailed animations */
    .manga-card .cover-image {
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .manga-card:hover .cover-image {
        transform: scale(1.08);
    }
    .manga-card .info-overlay {
        background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0) 100%);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .manga-card:hover .info-overlay {
        opacity: 1;
        transform: translateY(0);
    }
    .manga-card .chapter-badge {
        transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .manga-card:hover .chapter-badge {
        background-color: #38bdf8;
        transform: scale(1.1);
    }
</style>

<div class="container mx-auto px-4 space-y-20 sm:space-y-24 py-10">

    <!-- Featured Section -->
    <section id="featured-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[70vh] min-h-[550px] max-h-[650px]">
        <div id="featured-main" class="lg:col-span-2 h-full bg-zinc-900 rounded-2xl animate-shimmer"></div>
        <div class="hidden lg:flex flex-col gap-6 h-full">
            <div id="featured-side-1" class="h-1/2 bg-zinc-900 rounded-2xl animate-shimmer"></div>
            <div id="featured-side-2" class="h-1/2 bg-zinc-900 rounded-2xl animate-shimmer"></div>
        </div>
    </section>

    <!-- Stats Section -->
    <section id="stats-section">
        <%- include('partials/_stats') %>
    </section>

    <!-- Explore Section with FIXED Tab Switcher -->
    <section id="explore-section">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-3">
            <h2 class="text-3xl sm:text-4xl font-bold text-sky-400 mb-6 sm:mb-0">کاوش در دنیای تارگو</h2>
            <div id="tabs-container" class="tabs-container">
                <div id="tab-glider" class="tab-glider"></div>
                <button class="tab-button active" data-tab="latest-updates">🚀 بروزرسانی‌ها</button>
                <button class="tab-button" data-tab="popular">🔥 محبوب‌ترین‌ها</button>
                <button class="tab-button" data-tab="recent">✨ جدیدترین‌ها</button>
            </div>
        </div>
        
        <div id="tab-content-container">
            <div id="latest-updates-carousel" class="carousel-content flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4 -mx-4 px-4">
                <% for (let i = 0; i < 8; i++) { %><div class="flex-shrink-0 w-48"><div class="bg-zinc-900 rounded-lg animate-shimmer aspect-[2/3]"></div></div><% } %>
            </div>
            <div id="popular-mangas-carousel" class="carousel-content hidden flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4 -mx-4 px-4">
                 <% for (let i = 0; i < 8; i++) { %><div class="flex-shrink-0 w-48"><div class="bg-zinc-900 rounded-lg animate-shimmer aspect-[2/3]"></div></div><% } %>
            </div>
            <div id="recent-mangas-carousel" class="carousel-content hidden flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4 -mx-4 px-4">
                <% for (let i = 0; i < 8; i++) { %><div class="flex-shrink-0 w-48"><div class="bg-zinc-900 rounded-lg animate-shimmer aspect-[2/3]"></div></div><% } %>
            </div>
        </div>
    </section>

    <!-- Other sections remain the same... -->
    <section id="genre-spotlight-section" class="bg-gradient-to-br from-amber-500/10 via-zinc-900/10 to-zinc-900/10 p-8 rounded-2xl border border-zinc-800">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
            <div class="md:col-span-1 text-center md:text-right">
                <h3 class="text-zinc-400 text-lg font-semibold">ژانر منتخب هفته</h3>
                <h2 class="text-5xl font-extrabold text-amber-400 my-3">فانتزی</h2>
                <p class="text-zinc-300 leading-relaxed mb-6">
                    سفری به دنیاهای جادویی، موجودات افسانه‌ای و ماجراجویی‌های حماسی که تخیل شما را به پرواز در می‌آورند.
                </p>
                <a href="/mangas?genres=FANTASY_GENRE_ID" class="inline-block bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition-colors transform hover:scale-105">
                    مشاهده همه آثار فانتزی
                </a>
            </div>
            <div id="genre-spotlight-carousel" class="md:col-span-2 flex gap-5 overflow-x-auto custom-scrollbar pt-3 pb-4 -mr-8 pr-8">
                 <% for (let i = 0; i < 4; i++) { %><div class="flex-shrink-0 w-48"><div class="bg-zinc-900 rounded-lg animate-shimmer aspect-[2/3]"></div></div><% } %>
            </div>
        </div>
    </section>

    <section id="top-channels-section">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl sm:text-4xl font-bold text-green-400">📢 تیم‌های برتر ترجمه</h2>
            <a href="/channels" class="text-sm text-sky-400 hover:text-sky-300 transition-colors">مشاهده همه تیم‌ها &raquo;</a>
        </div>
        <div id="top-channels-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <% for (let i = 0; i < 4; i++) { %><div class="bg-zinc-900 rounded-lg animate-shimmer h-24"></div><% } %>
        </div>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Functions to create cards (same as before)
    function createMangaCard(manga) {
        return `
            <a href="/manga/${manga.id}" class="manga-card block bg-zinc-900 rounded-lg shadow-lg overflow-hidden group relative aspect-[2/3] w-48 flex-shrink-0">
                <img src="${manga.cover_image_url || 'https://placehold.co/320x480/1f2937/374151?text=کاور'}"
                     alt="[کاور ${manga.title}]" class="cover-image w-full h-full object-cover" loading="lazy">
                <div class="absolute top-2 right-2 chapter-badge bg-black/60 text-white text-xs font-semibold px-2.5 py-1 rounded-md backdrop-blur-sm">
                    ${manga.latest_chapter_number || '?'} چپتر
                </div>
                <div class="info-overlay absolute inset-0 p-4 flex flex-col justify-end">
                    <h3 class="font-bold text-white text-xl leading-tight">${manga.title}</h3>
                    <p class="text-sm text-zinc-300 mt-1">${manga.source_channel_name || 'نامشخص'}</p>
                </div>
            </a>
        `;
    }
    function createChannelCard(channel) {
        return `
            <a href="/channel/${channel.id}" class="bg-zinc-900 p-4 rounded-lg flex items-center gap-4 hover:bg-zinc-800/50 transition-colors group border border-transparent hover:border-green-500/50">
                <img src="${channel.profile_image_url || 'https://placehold.co/64x64/374151/9ca3af?text=' + encodeURIComponent(channel.name.substring(0,1))}"
                     alt="[پروفایل ${channel.name}]" class="w-16 h-16 rounded-full object-cover border-2 border-zinc-700 group-hover:border-green-400 transition-all duration-300 transform group-hover:scale-110">
                <div class="overflow-hidden">
                    <h3 class="font-semibold text-zinc-100 truncate group-hover:text-green-300 transition-colors" title="${channel.name}">${channel.name}</h3>
                    <p class="text-sm text-zinc-400">${channel.manga_count || 0} اثر</p>
                </div>
            </a>
        `;
    }
    function createFeaturedCard(manga, isMain = false) {
        const genresHTML = (manga.genres || []).slice(0, 3).map(g => `<span class="text-xs font-semibold px-3 py-1 bg-white/10 backdrop-blur-sm rounded-full">${g.name}</span>`).join('');
        if (isMain) {
            return `
                <div class="relative w-full h-full rounded-2xl overflow-hidden group">
                    <img src="${manga.banner_image_url || manga.cover_image_url}" class="absolute inset-0 w-full h-full object-cover object-center transition-transform duration-500 group-hover:scale-105" alt="[بنر ${manga.title}]">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent"></div>
                    <div class="relative z-10 flex flex-col justify-end h-full p-6 sm:p-8 text-white">
                        <h2 class="text-4xl lg:text-5xl font-extrabold" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">${manga.title}</h2>
                        <p class="mt-3 max-w-xl text-zinc-200 line-clamp-2 leading-relaxed">${manga.description || ''}</p>
                        <div class="flex flex-wrap gap-2 my-5">${genresHTML}</div>
                        <a href="/manga/${manga.id}" class="mt-4 bg-sky-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-600 transition-all transform hover:scale-105 shadow-lg w-fit">
                            مشاهده و خواندن
                        </a>
                    </div>
                </div>
            `;
        } else {
             return `
                <a href="/manga/${manga.id}" class="relative w-full h-full rounded-2xl overflow-hidden group block">
                    <img src="${manga.cover_image_url}" class="absolute inset-0 w-full h-full object-cover object-center transition-transform duration-300 group-hover:scale-105" alt="[کاور ${manga.title}]">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                    <div class="relative z-10 flex flex-col justify-end h-full p-4 text-white">
                        <h3 class="font-bold text-xl">${manga.title}</h3>
                        <span class="text-sm text-sky-300 group-hover:underline mt-1">شروع خواندن &raquo;</span>
                    </div>
                </a>
            `;
        }
    }
    function populateCarousel(carouselElement, items, cardCreatorFunction) {
        if (!carouselElement) return;
        if (!items || items.length === 0) {
            carouselElement.innerHTML = '<p class="text-zinc-400 px-4">موردی برای نمایش یافت نشد.</p>';
            return;
        }
        carouselElement.innerHTML = items.map(cardCreatorFunction).join('');
    }
    function populateGrid(gridElement, items, cardCreatorFunction) {
        if (!gridElement) return;
        if (!items || items.length === 0) {
            gridElement.innerHTML = '<p class="text-zinc-400 px-4 col-span-full text-center">موردی برای نمایش یافت نشد.</p>';
            return;
        }
        gridElement.innerHTML = items.map(cardCreatorFunction).join('');
    }
    function animateCount(elementId, finalValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        let startValue = 0;
        const duration = 1500;
        const stepTime = Math.max(1, Math.floor(duration / finalValue));
        const timer = setInterval(() => {
            startValue += Math.ceil(finalValue / (duration / stepTime));
            if (startValue >= finalValue) {
                startValue = finalValue;
                clearInterval(timer);
            }
            element.textContent = startValue.toLocaleString('fa-IR');
        }, stepTime);
    }

    // --- FIXED: Advanced Tab Switcher Logic ---
    const tabsContainer = document.getElementById('tabs-container');
    const tabGlider = document.getElementById('tab-glider');
    const tabButtons = tabsContainer.querySelectorAll('.tab-button');
    const tabContentContainer = document.getElementById('tab-content-container');

    function moveGlider(targetTab) {
        const targetRect = targetTab.getBoundingClientRect();
        const containerRect = tabsContainer.getBoundingClientRect();
        
        tabGlider.style.width = `${targetRect.width}px`;
        tabGlider.style.transform = `translateX(${targetRect.left - containerRect.left}px)`;
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Update button active state
            tabsContainer.querySelector('.active').classList.remove('active');
            button.classList.add('active');
            
            // Move the glider
            moveGlider(button);

            // Switch content
            Array.from(tabContentContainer.children).forEach(content => {
                const isTarget = content.id === `${button.dataset.tab}-carousel`;
                if (isTarget) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });

    // Function to initialize or update glider position
    function updateGliderPosition() {
        const activeTab = tabsContainer.querySelector('.active');
        if (activeTab) {
            moveGlider(activeTab);
        }
    }

    // Initialize glider position after a short delay to ensure layout is stable
    setTimeout(updateGliderPosition, 100);

    // Update glider on window resize
    window.addEventListener('resize', updateGliderPosition);


    // --- Data Fetching and Population ---
    fetch('/api/home-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.popularMangas && data.popularMangas.length > 0) {
                    document.getElementById('featured-main').innerHTML = createFeaturedCard(data.popularMangas[0], true);
                    if (data.popularMangas.length > 1) document.getElementById('featured-side-1').innerHTML = createFeaturedCard(data.popularMangas[1], false);
                    if (data.popularMangas.length > 2) document.getElementById('featured-side-2').innerHTML = createFeaturedCard(data.popularMangas[2], false);
                }

                populateCarousel(document.getElementById('latest-updates-carousel'), data.latestUpdates, createMangaCard);
                populateCarousel(document.getElementById('popular-mangas-carousel'), data.popularMangas, createMangaCard);
                populateCarousel(document.getElementById('recent-mangas-carousel'), data.recentMangas, createMangaCard);
                
                populateCarousel(document.getElementById('genre-spotlight-carousel'), data.popularMangas.slice(3, 9), createMangaCard);
                populateGrid(document.getElementById('top-channels-grid'), data.suggestedChannels.slice(0, 4), createChannelCard);

                if (data.siteStats) {
                    animateCount('stats-manga-count', data.siteStats.mangaCount);
                    animateCount('stats-chapter-count', data.siteStats.chapterCount);
                    animateCount('stats-channel-count', data.siteStats.channelCount);
                }
            } else { throw new Error(data.message || 'Failed to load data.'); }
        })
        .catch(error => {
            console.error('Error fetching homepage data:', error);
            const errorMsg = '<p class="text-red-400 text-center w-full p-10">خطا در بارگذاری اطلاعات.</p>';
            document.getElementById('featured-section').innerHTML = errorMsg;
            document.getElementById('explore-section').innerHTML = errorMsg;
        });
});
</script>

<%- include('partials/footer') %>
