<%- include('partials/header') %>

<style>
    .gradient-bg {
        background: linear-gradient(135deg, var(--primary) 0%, #0a0a0c 50%, var(--secondary) 100%);
    }

    .hero {
        background: linear-gradient(135deg, var(--secondary) 0%, rgba(37, 99, 235, 0.1) 100%);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
    }

    .hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 20%, rgba(37, 99, 235, 0.1), transparent 70%);
    }

    .card {
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        border-color: var(--accent);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 1.5rem;
    }

    .grid-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
    }

    .manga-card {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .manga-card:hover {
        transform: scale(1.02);
    }

    .manga-image {
        aspect-ratio: 2/3;
        object-fit: cover;
        width: 100%;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin: 3rem 0;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--secondary), rgba(37, 99, 235, 0.05));
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--accent);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .shimmer {
        background: linear-gradient(90deg, var(--secondary) 25%, var(--border) 50%, var(--secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .btn-link {
        color: var(--accent);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .btn-link:hover {
        color: var(--accent-light);
    }
</style>

<div class="gradient-bg min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8 space-y-12">

        <!-- Hero Section -->
        <section class="hero p-8 text-center relative">
            <div class="relative z-10">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">
                    <span class="bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
                        دنیای مانگا
                    </span>
                </h1>
                <p class="text-lg text-gray-300 mb-6 max-w-xl mx-auto">
                    بهترین مجموعه مانگاهای ترجمه شده را کشف کنید
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <a href="/mangas" class="btn btn-primary">
                        مشاهده مانگاها
                    </a>
                    <a href="/channels" class="border border-gray-600 text-white px-6 py-2.5 rounded-lg hover:bg-gray-800 transition-colors">
                        کانال‌های ترجمه
                    </a>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section>
            <%- include('partials/_stats') %>
        </section>

        <!-- Latest Updates -->
        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="section-title">آخرین بروزرسانی‌ها</h2>
                <a href="/mangas?sort_by=updated_at_desc" class="btn-link">
                    مشاهده همه ←
                </a>
            </div>
            <div id="latest-updates" class="grid-cards">
                <!-- Skeleton loaders -->
                <% for (let i = 0; i < 6; i++) { %>
                    <div class="card">
                        <div class="shimmer aspect-[2/3]"></div>
                        <div class="p-3">
                            <div class="shimmer h-4 rounded mb-2"></div>
                            <div class="shimmer h-3 rounded w-2/3"></div>
                        </div>
                    </div>
                <% } %>
            </div>
        </section>

        <!-- Recent Mangas -->
        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="section-title">جدیدترین‌ها</h2>
                <a href="/mangas" class="btn-link">
                    مشاهده همه ←
                </a>
            </div>
            <div id="recent-mangas" class="grid-cards">
                <!-- Skeleton loaders -->
                <% for (let i = 0; i < 6; i++) { %>
                    <div class="card">
                        <div class="shimmer aspect-[2/3]"></div>
                        <div class="p-3">
                            <div class="shimmer h-4 rounded mb-2"></div>
                            <div class="shimmer h-3 rounded w-2/3"></div>
                        </div>
                    </div>
                <% } %>
            </div>
        </section>

        <!-- Popular Mangas -->
        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="section-title">محبوب‌ترین‌ها</h2>
                <a href="/mangas?sort_by=view_count_desc" class="btn-link">
                    مشاهده همه ←
                </a>
            </div>
            <div id="popular-mangas" class="grid-cards">
                <!-- Skeleton loaders -->
                <% for (let i = 0; i < 6; i++) { %>
                    <div class="card">
                        <div class="shimmer aspect-[2/3]"></div>
                        <div class="p-3">
                            <div class="shimmer h-4 rounded mb-2"></div>
                            <div class="shimmer h-3 rounded w-2/3"></div>
                        </div>
                    </div>
                <% } %>
            </div>
        </section>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    function getStatusInfo(status) {
        const statusMap = {
            'Ongoing': { text: 'ادامه دارد', class: 'bg-green-500/20 text-green-300' },
            'Completed': { text: 'تمام شده', class: 'bg-blue-500/20 text-blue-300' },
            'Hiatus': { text: 'متوقف', class: 'bg-yellow-500/20 text-yellow-300' },
            'Dropped': { text: 'رها شده', class: 'bg-red-500/20 text-red-300' },
            'Upcoming': { text: 'به زودی', class: 'bg-purple-500/20 text-purple-300' }
        };
        return statusMap[status] || { text: 'نامشخص', class: 'bg-gray-500/20 text-gray-300' };
    }

    function createMangaCard(manga) {
        const status = getStatusInfo(manga.status);

        return `
            <div class="manga-card card group">
                <a href="/manga/${manga.id}" class="block">
                    <div class="relative">
                        <img src="${manga.cover_image_url || 'https://placehold.co/300x450/1a1a1d/3b82f6?text=کاور'}"
                             alt="${manga.title}"
                             class="manga-image">

                        <div class="absolute top-2 right-2">
                            <span class="text-xs px-2 py-1 rounded-md ${status.class}">
                                ${status.text}
                            </span>
                        </div>

                        <div class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded-md">
                            ${manga.view_count ? manga.view_count.toLocaleString('fa-IR') : '0'} بازدید
                        </div>

                        <div class="absolute bottom-2 right-2 bg-blue-500/80 text-white text-xs px-2 py-1 rounded-md">
                            ${manga.latest_chapter_number || '0'} چپتر
                        </div>
                    </div>

                    <div class="p-3">
                        <h3 class="font-semibold text-white mb-1 group-hover:text-blue-400 transition-colors line-clamp-2">
                            ${manga.title}
                        </h3>
                        <p class="text-sm text-gray-400">
                            ${manga.source_channel_name || 'نامشخص'}
                        </p>
                    </div>
                </a>
            </div>
        `;
    }

    function loadData(elementId, items, cardFunction) {
        const element = document.getElementById(elementId);
        if (!element) return;

        if (!items || items.length === 0) {
            element.innerHTML = '<p class="text-gray-400 text-center col-span-full py-8">موردی یافت نشد</p>';
            return;
        }

        element.innerHTML = items.map(cardFunction).join('');
    }

    function animateCounter(elementId, finalValue) {
        const element = document.getElementById(elementId);
        if (!element) return;

        let current = 0;
        const increment = Math.ceil(finalValue / 50);
        const timer = setInterval(() => {
            current += increment;
            if (current >= finalValue) {
                current = finalValue;
                clearInterval(timer);
            }
            element.textContent = current.toLocaleString('fa-IR');
        }, 40);
    }

    // Load homepage data
    fetch('/api/home-data')
        .then(response => response.ok ? response.json() : Promise.reject('Network error'))
        .then(data => {
            if (data.success) {
                loadData('recent-mangas', data.recentMangas, createMangaCard);
                loadData('popular-mangas', data.popularMangas, createMangaCard);
                loadData('latest-updates', data.latestUpdates, createMangaCard);

                if (data.siteStats) {
                    animateCounter('stats-manga-count', data.siteStats.mangaCount);
                    animateCounter('stats-chapter-count', data.siteStats.chapterCount);
                    animateCounter('stats-channel-count', data.siteStats.channelCount);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            ['latest-updates', 'recent-mangas', 'popular-mangas'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<p class="text-red-400 text-center col-span-full py-8">خطا در بارگذاری</p>';
            });
        });
});
</script>

<%- include('partials/footer') %>